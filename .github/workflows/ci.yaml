name: CI/CD

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}
  CHART_NAME: lvminit           # If your chart has a different name, change this
  CHART_DIR: helm               # Folder where Chart.yaml is (change if not 'helm')

jobs:
  pr-build-e2e:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with latest tag
        run: make docker-build IMAGE_NAME=$DOCKER_IMAGE:latest

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Start Kind cluster
        uses: helm/kind-action@v1.14.0
        with:
          install_only: true

      - name: Run e2e tests
        run: make e2e

      - name: Clean test environment
        run: make clean

  release:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Calculate next tag
        id: version
        run: |
          last_tag=$(git tag --list --sort=-v:refname | head -n1 | sed 's/^v//')
          if [ -z "$last_tag" ]; then
            next_tag="0.1.0"
          else
            IFS=. read -r major minor patch <<<"$last_tag"
            patch=$((patch+1))
            next_tag="$major.$minor.$patch"
          fi
          echo "NEXT_TAG=$next_tag" >> $GITHUB_OUTPUT
          echo "last_tag=$last_tag"  >> $GITHUB_OUTPUT

      # Bump Chart.yaml version for packaging (no commit/push needed)
      - name: Update Chart.yaml version to match tag
        run: |
          sed -i "s/^version:.*/version: \"${{ steps.version.outputs.NEXT_TAG }}\"/" $CHART_DIR/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.NEXT_TAG }}\"/" $CHART_DIR/Chart.yaml

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with new tag
        run: make docker-build IMAGE_NAME=$DOCKER_IMAGE:${{ steps.version.outputs.NEXT_TAG }}

      - name: Build Docker image with latest tag
        run: make docker-build IMAGE_NAME=$DOCKER_IMAGE:latest

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker images
        run: |
          docker push $DOCKER_IMAGE:${{ steps.version.outputs.NEXT_TAG }}
          docker push $DOCKER_IMAGE:latest

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Start Kind cluster
        uses: helm/kind-action@v1.14.0
        with:
          install_only: true

      - name: Run e2e tests (new version)
        run: make e2e

      - name: Clean test environment
        run: make clean

      - name: Create and push git tag
        run: |
          git tag ${{ steps.version.outputs.NEXT_TAG }}
          git push origin ${{ steps.version.outputs.NEXT_TAG }}

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.NEXT_TAG }}
          name: "Release ${{ steps.version.outputs.NEXT_TAG }}"
          draft: false
          prerelease: false

      # Publish Helm chart to gh-pages via chart-releaser
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          charts_dir: ${{ env.CHART_DIR }}

      - name: Update Release Notes with usage instructions
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const version = '${{ steps.version.outputs.NEXT_TAG }}';
            const dockerImage = 'ghcr.io/${{ github.repository }}:' + version;
            const chartName = '${{ env.CHART_NAME }}';
            const repoUrl = `https://${owner}.github.io/${repo}/`;
            const helmChartVersion = version;
            const body = [
              '## Usage',
              '',
              '### Docker Image',
              '',
              '```sh',
              `docker pull ${dockerImage}`,
              '```',
              '',
              '### Helm Chart',
              '',
              'Add repo and install:',
              '```sh',
              `helm repo add lvminit ${repoUrl}`,
              'helm repo update',
              `helm install myrelease lvminit/${chartName} --version ${helmChartVersion}`,
              '```',
              '',
              '[See all assets and index.yaml here.](' + `${repoUrl}index.yaml` + ')'
            ].join('\n');
            // Get release ID for the current tag
            const releases = await github.rest.repos.listReleases({ owner, repo });
            const release = releases.data.find(r => r.tag_name === version || r.tag_name === 'v'+version);
            if (!release) throw new Error(`Release for tag ${version} not found`);
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              body
            });
