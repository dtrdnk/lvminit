name: CI/CD

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}
  CHART_NAME: lvminit
  HELM_CHART_PATH: ./helm
  HELM_PACKAGE_OUTPUT: ./charts-out

jobs:
  pr-build-e2e:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with latest tag
        run: make docker-build IMAGE_NAME=$DOCKER_IMAGE:latest

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Start Kind cluster
        uses: helm/kind-action@v1.14.0
        with:
          install_only: true

      - name: Run e2e tests
        run: make e2e

      - name: Clean test environment
        run: make clean

  release:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Calculate next tag
        id: version
        run: |
          last_tag=$(git tag --list --sort=-v:refname | head -n1 | sed 's/^v//')
          if [ -z "$last_tag" ]; then
            next_tag="0.1.0"
          else
            IFS=. read -r major minor patch <<<"$last_tag"
            patch=$((patch+1))
            next_tag="$major.$minor.$patch"
          fi
          echo "NEXT_TAG=$next_tag" >> $GITHUB_OUTPUT
          echo "last_tag=$last_tag"  >> $GITHUB_OUTPUT

      - name: Bump Helm chart version
        run: |
          sed -i "s/^version:.*/version: \"${{ steps.version.outputs.NEXT_TAG }}\"/" $HELM_CHART_PATH/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.NEXT_TAG }}\"/" $HELM_CHART_PATH/Chart.yaml

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with new tag
        run: make docker-build IMAGE_NAME="$DOCKER_IMAGE:${{ steps.version.outputs.NEXT_TAG }} -t $DOCKER_IMAGE:latest"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker images
        run: |
          docker push $DOCKER_IMAGE:${{ steps.version.outputs.NEXT_TAG }}
          docker push $DOCKER_IMAGE:latest

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Start Kind cluster
        uses: helm/kind-action@v1.14.0
        with:
          install_only: true

      - name: Run e2e tests
        run: make e2e

      - name: Clean test environment
        run: make clean

      - name: Create and push git tag
        run: |
          git tag ${{ steps.version.outputs.NEXT_TAG }}
          git push origin ${{ steps.version.outputs.NEXT_TAG }}

      - name: Package Helm chart
        run: |
          mkdir -p $HELM_PACKAGE_OUTPUT
          helm package $HELM_CHART_PATH --destination $HELM_PACKAGE_OUTPUT

      # --- Prepare Helm chart repo (merge or create index.yaml in gh-pages) ---
      - name: Checkout gh-pages branch for repo index
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Prepare new chart index
        run: |
          mkdir -p gh-pages
          helm repo index $HELM_PACKAGE_OUTPUT \
            --url "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.NEXT_TAG }}" \
            --merge gh-pages/index.yaml
          cp $HELM_PACKAGE_OUTPUT/index.yaml gh-pages/

      # --- Find Helm chart tgz asset
      - name: Find Helm chart for release asset
        id: chart_file
        run: |
          chart=$(ls $HELM_PACKAGE_OUTPUT/lvminit-*.tgz | head -n1)
          echo "CHART_FILE=${chart}" >> $GITHUB_OUTPUT


      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.NEXT_TAG }}
          name: "Release ${{ steps.version.outputs.NEXT_TAG }}"
          draft: false
          prerelease: false
          files: |
            ${{ steps.chart_file.outputs.CHART_FILE }}

      # --- After successful e2e, publish Helm repo to gh-pages branch! ---
      - name: Publish Helm chart repo to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          keep_files: true
          force_orphan: false
          enable_jekyll: true

      - name: Update Release Notes with usage instructions
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const version = '${{ steps.version.outputs.NEXT_TAG }}';
            const dockerImage = 'ghcr.io/${{ github.repository }}:' + version;
            const chartName = '${{ env.CHART_NAME }}';
            const repoUrl = `https://${owner}.github.io/${repo}/`;
            const helmChartVersion = version;
            const body = [
              '## Usage',
              '',
              '### Docker Image',
              '',
              '```sh',
              `docker pull ${dockerImage}`,
              '```',
              '',
              '### Helm Chart',
              '',
              'Add repo and install:',
              '```sh',
              `helm repo add lvminit ${repoUrl}`,
              'helm repo update',
              `helm install myrelease lvminit/${chartName} --version ${helmChartVersion}`,
              '```',
              '',
              '[See all assets and index.yaml here.](' + `${repoUrl}index.yaml` + ')'
            ].join('\n');
            // Get release ID for the current tag
            const releases = await github.rest.repos.listReleases({ owner, repo });
            const release = releases.data.find(r => r.tag_name === version || r.tag_name === 'v'+version);
            if (!release) throw new Error(`Release for tag ${version} not found`);
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              body
            });
